name: Deploy Staging

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ======================================================
      # STEP 1: SETUP SSH AGENT & CONNECT TO SERVER
      # ======================================================
      - name: Deploy using SSH Action
        uses: appleboy/ssh-action@v1.0.1 # Action populer untuk koneksi SSH
        with:
          host: 172.104.51.79
          username: root
          key: "-----BEGIN OPENSSH PRIVATE KEY-----b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZWQyNTUxOQAAACDp6jMkzNs03d6t4TDUw4ACHe4FztH2wC3K+kxrNweGdwAAAJgUyN87FMjfOwAAAAtzc2gtZWQyNTUxOQAAACDp6jMkzNs03d6t4TDUw4ACHe4FztH2wC3K+kxrNweGdwAAAEDLubmZ6bwJlNkkYMs20gButTNzFiYzkqOBDtpTK2QjfOnqMyTM2zTd3q3hMNTDgAId7gXO0fbALcr6TGs3B4Z3AAAAFGZlcnJ5YTE5OTdAZ21haWwuY29tAQ==-----END OPENSSH PRIVATE KEY-----"
          port: 22 # Port SSH default

          # ======================================================
          # STEP 2: RUN COMMANDS ON THE REMOTE SERVER
          # ======================================================
          script: |
            # 1. Navigasi ke direktori aplikasi Anda di server
            # Ganti dengan path direktori Anda yang sebenarnya
            cd /var/www/portfolio

            # 2. Login ke GitHub Container Registry (GHCR) di server remote
            # Memastikan server bisa pull image dari GHCR
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # 3. Pull image terbaru dan jalankan ulang Docker Compose
            # 'docker compose pull' menarik image terbaru
            # 'docker compose up -d' menjalankan kontainer
            docker compose pull
            docker compose up -d

            # 4. Cleanup: Menghapus image lama yang tidak terpakai
            docker image prune -f

            echo "Deployment successful for ${{ github.sha }}"
