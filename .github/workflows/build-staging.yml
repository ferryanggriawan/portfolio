name: Build Staging

on:
  workflow_dispatch:
  push:
    tags: ["*.*.*"]

env:
  REGISTRY: ghcr.io
  REPOSITORY: ${{ github.repository }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build:
    environment: staging
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ======================================================
      # STEP 1: LOGIN KE CONTAINER REGISTRY
      # ======================================================
      - name: Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          # Menggunakan GITHUB_TOKEN bawaan untuk autentikasi
          password: ${{ secrets.GITHUB_TOKEN }}

      # ======================================================
      # STEP 2: BUILD SEMUA IMAGE DENGAN DOCKER COMPOSE
      # ======================================================
      - name: Docker Compose Build Images
        # Menggunakan --no-cache memastikan build selalu baru
        run: |
          cd deploy/staging
          docker compose build --no-cache

      # ======================================================
      # STEP 3: TAG DAN PUSH SEMUA IMAGE KE GHCR
      # ======================================================
      - name: Tag and Push Images
        shell: bash
        run: |
          SERVICE_NAMES=("frontend", "prometheus", "node-exporter")

          echo "Processing services: ${SERVICE_NAMES[*]}"

          for SERVICE in "${SERVICE_NAMES[@]}"; do
            # 1. Tentukan nama image lokal yang dibuat oleh Compose
            LOCAL_IMAGE="${SERVICE}"
            
            # 2. Tentukan nama image penuh untuk GHCR
            GHCR_IMAGE="${{ env.REGISTRY }}/${{ env.REPOSITORY }}/${SERVICE}"
            
            # 3. Retag image dengan tag SHA unik
            echo "Tagging ${LOCAL_IMAGE} as ${GHCR_IMAGE}:${{ env.IMAGE_TAG }}"
            docker tag ${LOCAL_IMAGE} ${GHCR_IMAGE}:${{ env.IMAGE_TAG }}
            docker tag ${LOCAL_IMAGE} ${GHCR_IMAGE}:latest
            
            # 4. Push image ke GHCR
            echo "Pushing ${GHCR_IMAGE}:${{ env.IMAGE_TAG }}..."
            docker push ${GHCR_IMAGE}:${{ env.IMAGE_TAG }}
            docker push ${GHCR_IMAGE}:latest
            
          done
